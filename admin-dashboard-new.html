<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Goodway Sacco Society</title>
    <link rel="stylesheet" href="admin-styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>

        <!-- Stats Section -->
        <div class="stats">
            <div class="card">
                <i class="fas fa-users stat-icon"></i>
                <h2>Total Members</h2>
                <p id="totalMembers">Loading...</p>
            </div>
            <div class="card">
                <i class="fas fa-credit-card stat-icon"></i>
                <h2>Active Loans</h2>
                <p id="activeLoans">Loading...</p>
            </div>
            <div class="card">
                <i class="fas fa-piggy-bank stat-icon"></i>
                <h2>Total Savings</h2>
                <p id="totalSavings">Loading...</p>
            </div>
            <div class="card">
                <i class="fas fa-clipboard-list stat-icon"></i>
                <h2>Pending Applications</h2>
                <p id="pendingApplications">Loading...</p>
            </div>
        </div>

        <!-- News Management Section -->
        <section>
            <h2><i class="fas fa-newspaper"></i> Manage News</h2>
            <form id="newsForm" class="admin-form">
                <div class="form-group">
                    <label for="newsTitle"><i class="fas fa-heading"></i> Title</label>
                    <input type="text" id="newsTitle" name="title" required />
                </div>
                <div class="form-group">
                    <label for="newsContent"><i class="fas fa-align-left"></i> Content</label>
                    <textarea id="newsContent" name="content" required></textarea>
                </div>
                <div class="form-group">
                    <label for="newsImage"><i class="fas fa-image"></i> Image URL</label>
                    <input type="text" id="newsImage" name="image" />
                </div>
                <button type="submit" class="btn-primary"><i class="fas fa-plus"></i> Add News</button>
            </form>
            <div id="newsError" class="error-message"></div>
            <h3><i class="fas fa-list"></i> Existing News</h3>
            <ul id="newsList" class="admin-list"></ul>
        </section>

        <!-- Job Management Section -->
        <section>
            <h2><i class="fas fa-briefcase"></i> Manage Jobs</h2>
            <form id="jobForm" class="admin-form">
                <div class="form-group">
                    <label for="jobTitle"><i class="fas fa-heading"></i> Title</label>
                    <input type="text" id="jobTitle" name="title" required />
                </div>
                <div class="form-group">
                    <label for="jobDescription"><i class="fas fa-align-left"></i> Description</label>
                    <textarea id="jobDescription" name="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="jobRequirements"><i class="fas fa-list-check"></i> Requirements</label>
                    <textarea id="jobRequirements" name="requirements" required></textarea>
                </div>
                <div class="form-group">
                    <label for="jobDeadline"><i class="fas fa-calendar-alt"></i> Application Deadline</label>
                    <input type="date" id="jobDeadline" name="deadline" required />
                </div>
                <button type="submit" class="btn-primary"><i class="fas fa-plus"></i> Add Job</button>
            </form>
            <div id="jobError" class="error-message"></div>
            <h3><i class="fas fa-list"></i> Existing Jobs</h3>
            <ul id="jobList" class="admin-list"></ul>
        </section>

        <!-- Contact Messages Section -->
        <section>
            <h2><i class="fas fa-envelope"></i> Contact Messages</h2>
            <ul id="contactList" class="admin-list"></ul>
        </section>

        <!-- Logout Button -->
        <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            alert('No token found. Please login first.');
            window.location.href = 'login.html';
            throw new Error('No token found');
        }

        // Fetch and display stats
        async function loadStats() {
            try {
                const response = await fetch('http://localhost:3001/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                const stats = await response.json();
                document.getElementById('totalMembers').textContent = stats.totalMembers || '0';
                document.getElementById('activeLoans').textContent = stats.activeLoans || '0';
                document.getElementById('totalSavings').textContent = stats.totalSavings || 'KSh 0';
                document.getElementById('pendingApplications').textContent = stats.pendingApplications || '0';
            } catch (error) {
                console.error('Error loading stats:', error);
                // Set default values
                document.getElementById('totalMembers').textContent = '0';
                document.getElementById('activeLoans').textContent = '0';
                document.getElementById('totalSavings').textContent = 'KSh 0';
                document.getElementById('pendingApplications').textContent = '0';
            }
        }

        // Load news
        async function loadNews() {
            try {
                const response = await fetch('http://localhost:3001/api/news');
                if (!response.ok) {
                    throw new Error('Failed to load news');
                }
                const news = await response.json();
                const newsList = document.getElementById('newsList');
                newsList.innerHTML = '';
                if (news.length === 0) {
                    newsList.innerHTML = '<li class="no-items">No news items found</li>';
                    return;
                }
                news.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'admin-item';
                    li.innerHTML = `
                        <div class="item-content">
                            <h4>${item.title}</h4>
                            <p>${item.content.substring(0, 100)}...</p>
                        </div>
                        <div class="item-actions">
                            <button onclick="editNews(${item.id})" class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteNews(${item.id})" class="btn-delete"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    newsList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading news:', error);
                document.getElementById('newsError').textContent = 'Error loading news';
            }
        }

        // Load jobs
        async function loadJobs() {
            try {
                const response = await fetch('http://localhost:3001/api/jobs');
                if (!response.ok) {
                    throw new Error('Failed to load jobs');
                }
                const jobs = await response.json();
                const jobList = document.getElementById('jobList');
                jobList.innerHTML = '';
                if (jobs.length === 0) {
                    jobList.innerHTML = '<li class="no-items">No job postings found</li>';
                    return;
                }
                jobs.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'admin-item';
                    li.innerHTML = `
                        <div class="item-content">
                            <h4>${item.title}</h4>
                            <p>${item.description.substring(0, 100)}...</p>
                        </div>
                        <div class="item-actions">
                            <button onclick="editJob(${item.id})" class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteJob(${item.id})" class="btn-delete"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    jobList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('jobError').textContent = 'Error loading jobs';
            }
        }

        // Load contact messages
        async function loadContacts() {
            try {
                const response = await fetch('http://localhost:3001/api/admin/contacts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to load contacts');
                }
                const contacts = await response.json();
                const contactList = document.getElementById('contactList');
                contactList.innerHTML = '';
                if (contacts.length === 0) {
                    contactList.innerHTML = '<li class="no-items">No contact messages found</li>';
                    return;
                }
                contacts.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'admin-item';
                    li.innerHTML = `
                        <div class="item-content">
                            <h4>${item.name}</h4>
                            <p><strong>Email:</strong> ${item.email}</p>
                            <p>${item.message.substring(0, 100)}...</p>
                        </div>
                    `;
                    contactList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading contacts:', error);
                const contactList = document.getElementById('contactList');
                contactList.innerHTML = '<li class="no-items">Error loading contact messages</li>';
            }
        }

        // Add news
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newsData = Object.fromEntries(formData);
            try {
                const response = await fetch('http://localhost:3001/api/admin/news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(newsData)
                });
                if (!response.ok) {
                    throw new Error('Failed to add news');
                }
                loadNews();
                e.target.reset();
                document.getElementById('newsError').textContent = 'News added successfully!';
                setTimeout(() => {
                    document.getElementById('newsError').textContent = '';
                }, 3000);
            } catch (error) {
                console.error('Error adding news:', error);
                document.getElementById('newsError').textContent = 'Error adding news';
            }
        });

        // Add job
        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const jobData = Object.fromEntries(formData);
            try {
                const response = await fetch('http://localhost:3001/api/admin/jobs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(jobData)
                });
                if (!response.ok) {
                    throw new Error('Failed to add job');
                }
                loadJobs();
                e.target.reset();
                document.getElementById('jobError').textContent = 'Job added successfully!';
                setTimeout(() => {
                    document.getElementById('jobError').textContent = '';
                }, 3000);
            } catch (error) {
                console.error('Error adding job:', error);
                document.getElementById('jobError').textContent = 'Error adding job';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        // Placeholder functions for edit and delete (to be implemented)
        function editNews(id) {
            alert(`Edit news functionality for ID ${id} to be implemented`);
        }

        function deleteNews(id) {
            if (confirm('Are you sure you want to delete this news item?')) {
                alert(`Delete news functionality for ID ${id} to be implemented`);
            }
        }

        function editJob(id) {
            alert(`Edit job functionality for ID ${id} to be implemented`);
        }

        function deleteJob(id) {
            if (confirm('Are you sure you want to delete this job posting?')) {
                alert(`Delete job functionality for ID ${id} to be implemented`);
            }
        }

        // Initialize
        loadStats();
        loadNews();
        loadJobs();
        loadContacts();
    </script>

    <!-- Include Shared Scripts -->
    <script src="shared-scripts.js"></script>
</body>
</html>
